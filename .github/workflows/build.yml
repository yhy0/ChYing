name: ChYing build

on:
  create:
    tags:
      - v*
  workflow_dispatch:


permissions:
  contents: write

jobs:
  build:
    # 只在创建标签时运行，而不是在创建分支时运行
    if: startsWith(github.ref, 'refs/tags/')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows AMD64
          - os: windows-latest
            goos: windows
            goarch: amd64
            artifact_name: ChYing-windows-amd64.exe
            build_task: windows:build
          # Linux AMD64
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            artifact_name: ChYing-linux-amd64
            build_task: linux:build
          # Linux ARM64
          - os: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
            artifact_name: ChYing-linux-arm64
            build_task: linux:build
          # macOS AMD64 (Intel)
          - os: macos-15
            goos: darwin
            goarch: amd64
            artifact_name: ChYing-macos-amd64.zip
            build_task: darwin:package
          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            goos: darwin
            goarch: arm64
            artifact_name: ChYing-macos-arm64.zip
            build_task: darwin:package

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install Linux Dependencies
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev build-essential pkg-config

      - name: Setup MinGW for Windows
        if: matrix.goos == 'windows'
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64
          static: 0

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Wails
        shell: bash
        run: |
          # 回到 GITHUB_WORKSPACE 的父目录
          cd ..
          # wails 仓库与项目目录同级
          git clone https://github.com/wailsapp/wails.git
          cd wails
          git checkout v3-alpha
          cd v3/cmd/wails3
          go install

      - name: Build
        working-directory: ${{ github.workspace }}
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
          CC: ${{ matrix.goos == 'windows' && 'gcc' || '' }}
          PRODUCTION: "true"
        run: |
          wails3 task ${{ matrix.build_task }}

      - name: Prepare Release Files
        id: prepare
        shell: bash
        run: |
          mkdir -p release
          if [ "${{ matrix.goos }}" = "windows" ]; then
            cp bin/*.exe "release/${{ matrix.artifact_name }}"
          elif [ "${{ matrix.goos }}" = "darwin" ]; then
            cp -r bin/*.app release/
            cd release && zip -r "${{ matrix.artifact_name }}" *.app && rm -rf *.app && cd ..
          else
            cp bin/* "release/${{ matrix.artifact_name }}"
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: release/${{ matrix.artifact_name }}
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true

      - name: Fetch release notes
        run: |
          # Get current tag
          current_tag=$(git describe --tags --abbrev=0)

          # Get previous tag
          previous_tag=$(git tag --sort=-creatordate | grep -v "^${current_tag}$" | head -n 1)

          echo "# Release $current_tag" > release_notes.txt
          echo "" >> release_notes.txt

          # Include tag annotation if present
          tag_message=$(git tag -l --format='%(contents)' "$current_tag" 2>/dev/null | sed '/^$/d' || echo "")
          if [ -n "$tag_message" ]; then
            echo "$tag_message" >> release_notes.txt
            echo "" >> release_notes.txt
          fi

          echo "## Changes" >> release_notes.txt
          echo "" >> release_notes.txt

          # Get commit list between previous tag and current tag
          if [ -n "$previous_tag" ]; then
            commits=$(git log --pretty=format:"%H" ${previous_tag}..${current_tag})
          else
            commits=$(git log --pretty=format:"%H" ${current_tag})
          fi

          if [ -n "$commits" ]; then
            for commit_hash in $commits; do
              subject=$(git log -1 --pretty=format:"%s" $commit_hash)
              body=$(git log -1 --pretty=format:"%b" $commit_hash)

              echo "- [$subject](https://github.com/${{ github.repository }}/commit/${commit_hash})" >> release_notes.txt

              if [ -n "$body" ]; then
                # Indent body lines under the commit entry
                echo "$body" | sed 's/^/  /' >> release_notes.txt
              fi

              echo "" >> release_notes.txt
            done
          else
            echo "First release" >> release_notes.txt
          fi

          # Add compare link
          if [ -n "$previous_tag" ]; then
            echo "---" >> release_notes.txt
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${previous_tag}...${current_tag}" >> release_notes.txt
          fi

          echo "Release notes:"
          cat release_notes.txt
        shell: bash

      - name: List Release Files
        run: ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          body_path: release_notes.txt
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: ChYing build

on:
  create:
    tags:
      - v*
  workflow_dispatch:


permissions:
  contents: write

jobs:
  release:
    # 只在创建标签时运行，而不是在创建分支时运行
    if: startsWith(github.ref, 'refs/tags/')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows AMD64
          - os: windows-latest
            goos: windows
            goarch: amd64
            artifact_name: ChYing-windows-amd64.exe
            build_task: windows:build
          # Linux AMD64
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            artifact_name: ChYing-linux-amd64
            build_task: linux:build
          # Linux ARM64
          - os: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
            artifact_name: ChYing-linux-arm64
            build_task: linux:build
          # macOS AMD64 (Intel)
          - os: macos-15
            goos: darwin
            goarch: amd64
            artifact_name: ChYing-macos-amd64.zip
            build_task: darwin:package
          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            goos: darwin
            goarch: arm64
            artifact_name: ChYing-macos-arm64.zip
            build_task: darwin:package

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install Linux Dependencies
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev build-essential pkg-config

      - name: Setup MinGW for Windows
        if: matrix.goos == 'windows'
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch commit messages since last release
        run: |
          # Get current tag
          current_tag=$(git describe --tags --abbrev=0)

          # Try to get previous tag
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate commit messages
          if [ -n "$previous_tag" ]; then
            # If previous tag exists, get commits between tags
            commit_messages=$(git log --pretty=format:"- [%s](https://github.com/${{ github.repository }}/commit/%H)" ${previous_tag}..${current_tag})
          else
            # If no previous tag exists, get all commits up to current tag
            commit_messages=$(git log --pretty=format:"- [%s](https://github.com/${{ github.repository }}/commit/%H)" ${current_tag})
          fi

          # Add release title
          echo "# Release $current_tag" > commits.txt
          echo "" >> commits.txt

          # Save commit messages
          if [ -n "$commit_messages" ]; then
            echo "## Changes" >> commits.txt
            echo "$commit_messages" >> commits.txt
          else
            echo "First release" >> commits.txt
          fi

          echo "Commit messages since last release:"
          cat commits.txt
          echo "commit_messages_path=$(pwd)/commits.txt" >> $GITHUB_ENV
        shell: bash

      - name: Install Wails
        shell: bash
        run: |
          # 回到 GITHUB_WORKSPACE 的父目录
          cd ..
          # wails 仓库与项目目录同级
          git clone https://github.com/wailsapp/wails.git
          cd wails
          git checkout v3-alpha
          cd v3/cmd/wails3
          go install

      - name: Build
        working-directory: ${{ github.workspace }}
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
          CC: ${{ matrix.goos == 'windows' && 'gcc' || '' }}
        run: |
          wails3 task ${{ matrix.build_task }}

      - name: Prepare Release Files
        id: prepare
        shell: bash
        run: |
          mkdir -p release
          if [ "${{ matrix.goos }}" = "windows" ]; then
            cp bin/*.exe "release/${{ matrix.artifact_name }}"
          elif [ "${{ matrix.goos }}" = "darwin" ]; then
            cp -r bin/*.app release/
            cd release && zip -r "${{ matrix.artifact_name }}" *.app && rm -rf *.app && cd ..
          else
            cp bin/* "release/${{ matrix.artifact_name }}"
          fi
          echo "ARTIFACT_PATH=release/${{ matrix.artifact_name }}" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ARTIFACT_PATH }}
          body_path: ${{ env.commit_messages_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

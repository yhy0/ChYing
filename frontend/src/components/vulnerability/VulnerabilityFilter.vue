<script setup lang="ts">
import { computed } from 'vue';
import { useI18n } from 'vue-i18n';
import type { VulnerabilityFilter } from '../../types/vulnerability';
import { VulnerabilityLevel } from '../../types/vulnerability';
import { getPluginColor } from '../../utils/colors';

const { t } = useI18n();

// Props
const props = defineProps<{
  filter: VulnerabilityFilter;
  availableTypes: string[];
  availablePlugins: string[];
}>();

// Emits
const emit = defineEmits<{
  'filter-change': [filter: Partial<VulnerabilityFilter>];
}>();

// 可用的漏洞等级
const availableLevels = [
  VulnerabilityLevel.CRITICAL,
  VulnerabilityLevel.HIGH,
  VulnerabilityLevel.MEDIUM,
  VulnerabilityLevel.LOW
];

// 漏洞等级配置
const levelConfig = {
  [VulnerabilityLevel.CRITICAL]: { color: 'var(--color-vuln-critical)', icon: 'bx-error-circle' },
  [VulnerabilityLevel.HIGH]: { color: 'var(--color-vuln-high)', icon: 'bx-error' },
  [VulnerabilityLevel.MEDIUM]: { color: 'var(--color-vuln-medium)', icon: 'bx-info-circle' },
  [VulnerabilityLevel.LOW]: { color: 'var(--color-vuln-low)', icon: 'bx-check-circle' }
};

// 计算激活的过滤器数量
const activeFiltersCount = computed(() => {
  let count = 0;
  if (props.filter.searchKeyword) count++;
  if (props.filter.targetHost) count++;
  if (props.filter.vulnTypes.length > 0) count++;
  if (props.filter.plugins.length > 0) count++;
  if (props.filter.levels.length > 0) count++;
  if (props.filter.dateRange.start || props.filter.dateRange.end) count++;
  return count;
});

// 计算插件选项（添加颜色信息）
const pluginOptions = computed(() => {
  return props.availablePlugins.map(plugin => {
    const pluginColor = getPluginColor(plugin);
    return {
      name: plugin,
      color: pluginColor.color,
      textClass: pluginColor.textClass,
      icon: getPluginIcon(plugin)
    };
  });
});

// 根据插件名称获取合适的图标
const getPluginIcon = (pluginName: string): string => {
  const name = pluginName.toLowerCase();
  if (name.includes('xss')) return 'bx-code-alt';
  if (name.includes('sql')) return 'bx-data';
  if (name.includes('auth')) return 'bx-shield-quarter';
  if (name.includes('upload')) return 'bx-upload';
  if (name.includes('xxe')) return 'bx-file-blank';
  if (name.includes('ssrf')) return 'bx-link-external';
  if (name.includes('cmd') || name.includes('inject')) return 'bx-terminal';
  if (name.includes('sensitive')) return 'bx-shield-alt-2';
  if (name.includes('waf')) return 'bx-shield-x';
  if (name.includes('brute')) return 'bx-key';
  if (name.includes('finger')) return 'bx-fingerprint';
  if (name.includes('port') || name.includes('scan')) return 'bx-search';
  if (name.includes('subdomain') || name.includes('domain')) return 'bx-network-chart';
  if (name.includes('directory') || name.includes('bbscan')) return 'bx-folder';
  if (name.includes('json')) return 'bx-bug';
  if (name.includes('swagger')) return 'bx-file-doc';
  if (name.includes('raw')) return 'bx-code';
  if (name.includes('http')) return 'bx-transfer-alt';
  if (name.includes('error')) return 'bx-error-circle';
  if (name.includes('bypass')) return 'bx-shield-x';
  return 'bx-plug';
};

// 处理搜索关键词变化
const handleSearchKeywordChange = (value: string) => {
  emit('filter-change', { searchKeyword: value });
};

// 处理目标主机变化
const handleTargetHostChange = (value: string) => {
  emit('filter-change', { targetHost: value });
};

// 处理漏洞类型选择
const handleVulnTypeToggle = (type: string) => {
  const currentTypes = [...props.filter.vulnTypes];
  const index = currentTypes.indexOf(type);
  
  if (index === -1) {
    currentTypes.push(type);
  } else {
    currentTypes.splice(index, 1);
  }
  
  emit('filter-change', { vulnTypes: currentTypes });
};

// 处理插件选择
const handlePluginToggle = (plugin: string) => {
  const currentPlugins = [...props.filter.plugins];
  const index = currentPlugins.indexOf(plugin);
  
  if (index === -1) {
    currentPlugins.push(plugin);
  } else {
    currentPlugins.splice(index, 1);
  }
  
  emit('filter-change', { plugins: currentPlugins });
};

// 处理等级选择
const handleLevelToggle = (level: VulnerabilityLevel) => {
  const currentLevels = [...props.filter.levels];
  const index = currentLevels.indexOf(level);
  
  if (index === -1) {
    currentLevels.push(level);
  } else {
    currentLevels.splice(index, 1);
  }
  
  emit('filter-change', { levels: currentLevels });
};

// 处理日期范围变化
const handleDateRangeChange = (field: 'start' | 'end', value: string) => {
  const newDateRange = { ...props.filter.dateRange };
  if (value) {
    newDateRange[field] = value;
  } else {
    delete newDateRange[field];
  }
  emit('filter-change', { dateRange: newDateRange });
};

// 清空所有过滤器
const clearAllFilters = () => {
  emit('filter-change', {
    searchKeyword: '',
    targetHost: '',
    vulnTypes: [],
    plugins: [],
    levels: [],
    dateRange: {}
  });
};
</script>

<template>
  <div class="filter-container scrollbar-thin">
    <!-- 过滤器头部 -->
    <div class="filter-header">
      <h3>{{ t('common.ui.filter') }}</h3>
      <div class="filter-actions">
        <span v-if="activeFiltersCount > 0" class="active-count">
          {{ activeFiltersCount }}
        </span>
        <button 
          v-if="activeFiltersCount > 0"
          @click="clearAllFilters"
          class="btn-icon"
          :title="t('common.actions.clear_all')"
        >
          <i class="bx bx-x"></i>
        </button>
      </div>
    </div>

    <!-- 搜索关键词 -->
    <div class="form-group spacing-sm">
      <label>{{ t('vulnerability.search_keyword') }}</label>
      <input 
        type="text"
        :value="filter.searchKeyword"
        @input="handleSearchKeywordChange(($event.target as HTMLInputElement).value)"
        :placeholder="t('vulnerability.search_placeholder')"
        class="filter-input"
        spellcheck="false"
      />
    </div>

    <!-- 目标主机 -->
    <div class="form-group spacing-sm">
      <label>{{ t('vulnerability.target_host') }}</label>
      <input 
        type="text"
        :value="filter.targetHost"
        @input="handleTargetHostChange(($event.target as HTMLInputElement).value)"
        :placeholder="t('vulnerability.target_host_placeholder')"
        class="filter-input"
        spellcheck="false"
      />
    </div>

    <!-- 漏洞等级 -->
    <div class="form-group spacing-sm">
      <label>{{ t('vulnerability.level') }}</label>
      <div class="checkbox-list">
        <div 
          v-for="level in availableLevels"
          :key="level"
          class="checkbox-item"
          :data-risk="level.toLowerCase()"
          @click="handleLevelToggle(level)"
        >
          <div class="checkbox-content">
            <i class="bx option-icon" :class="levelConfig[level].icon"></i>
            <div 
              class="level-badge-filter"
              :style="{ backgroundColor: levelConfig[level].color }"
            >
              <span>{{ level }}</span>
            </div>
          </div>
          <i 
            v-if="filter.levels.includes(level)"
            class="bx bx-check check-indicator"
          ></i>
        </div>
      </div>
    </div>

    <!-- 漏洞类型 -->
    <div class="form-group spacing-sm" v-if="availableTypes.length > 0">
      <label>{{ t('vulnerability.type') }}</label>
      <div class="checkbox-list">
        <div 
          v-for="type in availableTypes"
          :key="type"
          class="checkbox-item"
          @click="handleVulnTypeToggle(type)"
        >
          <div class="checkbox-content">
            <i class="bx bx-bug option-icon"></i>
            <span>{{ type }}</span>
          </div>
          <i 
            v-if="filter.vulnTypes.includes(type)"
            class="bx bx-check check-indicator"
          ></i>
        </div>
      </div>
    </div>

    <!-- 插件 -->
    <div class="form-group spacing-sm" v-if="availablePlugins.length > 0">
      <label>{{ t('vulnerability.plugin') }}</label>
      <div class="checkbox-list">
        <div 
          v-for="option in pluginOptions"
          :key="option.name"
          class="checkbox-item plugin-item"
          :data-plugin="option.name"
          :style="{ borderLeftColor: option.color }"
          @click="handlePluginToggle(option.name)"
        >
          <div class="checkbox-content">
            <i :class="option.icon" class="option-icon"></i>
            <div 
              class="plugin-color-badge"
              :style="{ backgroundColor: option.color }"
            >
              <span class="option-label">{{ option.name }}</span>
            </div>
          </div>
          <i 
            v-if="filter.plugins.includes(option.name)"
            class="bx bx-check check-indicator"
          ></i>
        </div>
      </div>
    </div>

    <!-- 日期范围 -->
    <div class="form-group">
      <label>{{ t('vulnerability.date_range') }}</label>
      <div class="date-range">
        <input 
          spellcheck="false"
          type="datetime-local"
          :value="filter.dateRange.start || ''"
          @input="handleDateRangeChange('start', ($event.target as HTMLInputElement).value)"
          class="filter-input date-input"
          :placeholder="t('vulnerability.start_date')"
        />
        <span class="date-separator">{{ t('common.ui.to') }}</span>
        <input 
          spellcheck="false"
          type="datetime-local"
          :value="filter.dateRange.end || ''"
          @input="handleDateRangeChange('end', ($event.target as HTMLInputElement).value)"
          class="filter-input date-input"
          :placeholder="t('vulnerability.end_date')"
        />
      </div>
    </div>
  </div>
</template>

<style scoped>
/* 基础样式 */
.filter-container {
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  height: 100%;
  overflow-y: auto;
}

.filter-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--color-border);
}

.filter-header h3 {
  margin: 0;
  font-size: 16px;
  color: var(--color-text-primary);
}

.filter-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.active-count {
  background: var(--color-primary);
  color: white;
  padding: 2px 6px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 500;
}

.btn-icon {
  width: 24px;
  height: 24px;
  border: none;
  background: var(--color-bg-hover);
  color: var(--color-text-secondary);
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s;
}

.btn-icon:hover {
  background: var(--color-danger);
  color: white;
}

/* 表单样式 */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  font-size: 12px;
  font-weight: 500;
  color: var(--color-text-secondary);
  margin-bottom: 4px;
}

.filter-input {
  padding: 8px 12px;
  border: 1px solid var(--color-border);
  border-radius: 6px;
  background: var(--color-bg-primary);
  color: var(--color-text-primary);
  font-size: 12px;
  transition: all 0.2s;
}

.filter-input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 2px var(--color-primary-light);
}

.filter-input::placeholder {
  color: var(--color-text-tertiary);
}

/* 复选框列表样式 */
.checkbox-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.checkbox-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid transparent;
}

.checkbox-item:hover {
  background: var(--color-bg-hover);
  border-color: var(--color-border);
}

.checkbox-content {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
}

.option-icon {
  color: var(--color-text-tertiary);
  font-size: 14px;
  flex-shrink: 0;
}

.checkbox-item span {
  font-size: 12px;
  color: var(--color-text-primary);
  flex: 1;
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
}

.check-indicator {
  color: var(--color-primary);
  font-size: 14px;
  flex-shrink: 0;
  animation: checkPulse 0.3s ease-out;
}

@keyframes checkPulse {
  0% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

/* 漏洞等级特殊样式 - 带风险等级边框指示 */
.checkbox-item[data-risk="critical"] {
  border-left: 3px solid var(--color-vuln-critical);
}

.checkbox-item[data-risk="high"] {
  border-left: 3px solid var(--color-vuln-high);
}

.checkbox-item[data-risk="medium"] {
  border-left: 3px solid var(--color-vuln-medium);
}

.checkbox-item[data-risk="low"] {
  border-left: 3px solid var(--color-vuln-low);
}

/* 漏洞等级徽章样式 */
.level-badge-filter {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 12px;
  color: white;
  font-size: 10px;
  font-weight: 500;
}

/* 插件项特殊样式 - 带插件颜色边框指示 */
.plugin-item {
  border-left: 3px solid transparent;
}

.plugin-color-badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 500;
  color: var(--color-text-primary);
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.plugin-color-badge .option-label {
  color: inherit;
  font-size: inherit;
}

/* 日期范围样式 */
.date-range {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.date-input {
  font-size: 11px;
}

.date-separator {
  text-align: center;
  font-size: 11px;
  color: var(--color-text-tertiary);
}

/* 间距工具类 */
.spacing-sm {
  margin-bottom: 12px;
}

.spacing-lg {
  margin-bottom: 20px;
}
</style> 
<script setup lang="ts">
import { computed } from 'vue';
import { useI18n } from 'vue-i18n';
import type { VulnerabilityStatistics } from '../../types/vulnerability';
import { getPluginColor } from '../../utils/colors';

const { t } = useI18n();

// Props
const props = defineProps<{
  statistics: VulnerabilityStatistics;
}>();

// 计算风险发现率
const riskDiscoveryRate = computed(() => {
  if (props.statistics.total === 0) return 0;
  const riskyVulns = props.statistics.critical + props.statistics.high + props.statistics.medium;
  return Math.round((riskyVulns / props.statistics.total) * 100);
});

// 漏洞等级分布数据
const levelDistribution = computed(() => [
  {
    label: 'Critical',
    count: props.statistics.critical,
    percentage: props.statistics.total > 0 ? Math.round((props.statistics.critical / props.statistics.total) * 100) : 0,
    color: 'var(--color-vuln-critical)'
  },
  {
    label: 'High', 
    count: props.statistics.high,
    percentage: props.statistics.total > 0 ? Math.round((props.statistics.high / props.statistics.total) * 100) : 0,
    color: 'var(--color-vuln-high)'
  },
  {
    label: 'Medium',
    count: props.statistics.medium,
    percentage: props.statistics.total > 0 ? Math.round((props.statistics.medium / props.statistics.total) * 100) : 0,
    color: 'var(--color-vuln-medium)'
  },
  {
    label: 'Low',
    count: props.statistics.low,
    percentage: props.statistics.total > 0 ? Math.round((props.statistics.low / props.statistics.total) * 100) : 0,
    color: 'var(--color-vuln-low)'
  }
]);

// 前5个插件数据
const topPlugins = computed(() => {
  return Object.entries(props.statistics.byPlugin)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 5)
    .map(([name, count]) => {
      const pluginColor = getPluginColor(name);
      return { 
        name, 
        count, 
        color: pluginColor.color,
        textClass: pluginColor.textClass
      };
    });
});

// 前5个漏洞类型数据
const topVulnTypes = computed(() => {
  return Object.entries(props.statistics.byType)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 5)
    .map(([name, count]) => ({ name, count }));
});
</script>

<template>
  <div class="statistics-container scrollbar-thin">
    <!-- 统计头部 -->
    <div class="stats-header">
      <h3>{{ t('vulnerability.statistics') }}</h3>
    </div>

    <!-- 总览统计 -->
    <div class="overview-stats spacing-lg">
      <div class="card stat-card">
        <div class="stat-number">{{ statistics.total }}</div>
        <div class="stat-label">{{ t('vulnerability.total_vulnerabilities') }}</div>
      </div>
      
      <div class="card stat-card">
        <div class="stat-number">{{ statistics.recent24h }}</div>
        <div class="stat-label">{{ t('vulnerability.recent_24h') }}</div>
      </div>
      
      <div class="card stat-card">
        <div class="stat-number">{{ riskDiscoveryRate }}%</div>
        <div class="stat-label">{{ t('vulnerability.risk_discovery_rate') }}</div>
      </div>
    </div>

    <!-- 风险等级分布 -->
    <div class="distribution-section spacing-lg">
      <h4>{{ t('vulnerability.level_distribution') }}</h4>
      <div class="level-stats">
        <div 
          v-for="level in levelDistribution"
          :key="level.label"
          class="level-stat"
        >
          <div class="level-info">
            <div 
              class="level-dot"
              :style="{ backgroundColor: level.color }"
            ></div>
            <span class="level-label text-truncate">{{ level.label }}</span>
            <span class="level-count">{{ level.count }}</span>
          </div>
          <div class="level-bar">
            <div 
              class="level-progress"
              :style="{ 
                width: level.percentage + '%',
                backgroundColor: level.color 
              }"
            ></div>
          </div>
          <span class="level-percentage">{{ level.percentage }}%</span>
        </div>
      </div>
    </div>

    <!-- 插件排行 -->
    <div class="ranking-section spacing-lg" v-if="topPlugins.length > 0">
      <h4>{{ t('vulnerability.top_plugins') }}</h4>
      <div class="ranking-list">
        <div 
          v-for="(plugin, index) in topPlugins"
          :key="plugin.name"
          class="card ranking-item plugin-ranking-item"
          :style="{ borderLeftColor: plugin.color }"
        >
          <div class="ranking-number">{{ index + 1 }}</div>
          <div 
            class="plugin-ranking-badge"
            :style="{ backgroundColor: plugin.color }"
          >
            <span class="ranking-name text-truncate" :title="plugin.name">{{ plugin.name }}</span>
          </div>
          <div class="ranking-count">{{ plugin.count }}</div>
        </div>
      </div>
    </div>

    <!-- 漏洞类型排行 -->
    <div class="ranking-section" v-if="topVulnTypes.length > 0">
      <h4>{{ t('vulnerability.top_types') }}</h4>
      <div class="ranking-list">
        <div 
          v-for="(type, index) in topVulnTypes"
          :key="type.name"
          class="card ranking-item"
        >
          <div class="ranking-number">{{ index + 1 }}</div>
          <div class="ranking-name text-truncate" :title="type.name">{{ type.name }}</div>
          <div class="ranking-count">{{ type.count }}</div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
/* 插件排行项特殊样式 */
.plugin-ranking-item {
  border-left: 3px solid transparent;
}

.plugin-ranking-badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 500;
  color: var(--color-text-primary);
  border: 1px solid rgba(0, 0, 0, 0.1);
  min-width: 0;
  flex: 1;
}

.plugin-ranking-badge .ranking-name {
  color: inherit;
  font-size: inherit;
  margin: 0;
  min-width: 0;
  flex: 1;
}
</style> 
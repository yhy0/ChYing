<script setup lang="ts">
import { ref, reactive, computed, watch, onMounted, onUnmounted } from 'vue';
import { useI18n } from 'vue-i18n';
import { getCurrentTheme } from '../theme';
import { i18n } from '../i18n';
import { useVulnerabilityStore } from '../store/vulnerability';
import VulnerabilityPanel from '../components/vulnerability/VulnerabilityPanel.vue';
import VulnerabilityFilter from '../components/vulnerability/VulnerabilityFilter.vue';
import VulnerabilityStatistics from '../components/vulnerability/VulnerabilityStatistics.vue';
import ConfirmDialog from '../components/common/ConfirmDialog.vue';
import type { 
  VulnerabilityItem, 
  VulnerabilityFilter as VulnFilter
} from '../types/vulnerability';

const { t } = useI18n();
const vulnerabilityStore = useVulnerabilityStore();

// 主题响应状态
const currentTheme = ref(getCurrentTheme());
const themeChangeKey = ref(0); // 用于强制重新渲染

// 过滤器状态
const filter = reactive<VulnFilter>({
  searchKeyword: '',
  targetHost: '',
  vulnTypes: [],
  plugins: [],
  levels: [],
  dateRange: {}
});

// 从 store 获取过滤后的漏洞数据
const filteredVulnerabilities = computed(() => {
  return vulnerabilityStore.getFilteredVulnerabilities(filter);
});

// 从 store 获取统计信息
const statistics = computed(() => vulnerabilityStore.statistics);

// 界面状态
const selectedVulnerability = ref<VulnerabilityItem | null>(null);
const showStatisticsPanel = ref(true);
const showFilterPanel = ref(true);
const showClearConfirm = ref(false);

// 切换统计面板
const toggleStatistics = () => {
  showStatisticsPanel.value = !showStatisticsPanel.value;
};

// 切换过滤器面板  
const toggleFilters = () => {
  showFilterPanel.value = !showFilterPanel.value;
};

// 刷新数据
const refreshData = () => {
  // 清理过期数据
  vulnerabilityStore.cleanupOldVulnerabilities();
};

// 导出数据
const exportData = () => {
  const dataToExport = vulnerabilityStore.vulnerabilities;
  const dataStr = JSON.stringify(dataToExport, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `vulnerabilities_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

// 清空数据（带跨窗口同步）
const clearData = () => {
  showClearConfirm.value = true;
};

// 确认清空数据
const handleConfirmClear = () => {
  vulnerabilityStore.clearAllVulnerabilitiesWithSync();
  selectedVulnerability.value = null;
};

// 处理漏洞选择
const handleVulnerabilitySelect = (vulnerability: VulnerabilityItem) => {
  selectedVulnerability.value = vulnerability;
};

// 处理过滤器变化
const handleFilterChange = (newFilter: Partial<VulnFilter>) => {
  Object.assign(filter, newFilter);
};

// 主题变化处理函数
const handleThemeChange = () => {
  currentTheme.value = getCurrentTheme();
  themeChangeKey.value++; // 强制重新渲染子组件
};

// localStorage变化处理函数（接收来自主界面的主题和语言变化）
const handleStorageChange = (e: StorageEvent) => {
  if (e.key === 'app-theme' && e.newValue) {
    const newTheme = e.newValue as 'light' | 'dark' | 'system';
    const isDark = newTheme === 'dark' || (newTheme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
    
    // 每个窗口需要自己更新DOM
    if (isDark) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
    
    handleThemeChange();
  }
  
  if (e.key === 'language' && e.newValue) {
    const newLang = e.newValue as 'en' | 'zh';
    // 同步语言设置
    i18n.global.locale.value = newLang;
    document.querySelector('html')?.setAttribute('lang', newLang);
  }
};

// 调试：监听数据变化
watch(() => vulnerabilityStore.vulnerabilities, () => {
}, { deep: true, immediate: true });

watch(filteredVulnerabilities, () => {
}, { deep: true, immediate: true });

// 组件挂载时从数据库加载数据
onMounted(async () => {
  // 从数据库加载漏洞数据
  await vulnerabilityStore.loadFromDatabase();

  // 监听localStorage变化（跨窗口数据同步 - 用于主题和语言）
  window.addEventListener('storage', handleStorageChange);
});

// 组件卸载时移除监听器
onUnmounted(() => {
  window.removeEventListener('storage', handleStorageChange);
});

</script>

<template>
  <div class="vulnerability-view" :key="`vulnerability-${themeChangeKey}`">
    <!-- 头部工具栏 -->
    <div class="section-header">
      <div class="header-actions">
        <button 
          @click="toggleFilters"
          class="btn btn-sm"
          :class="{ 'btn-primary': showFilterPanel, 'btn-secondary': !showFilterPanel }"
        >
          <i class="bx bx-filter"></i>
          {{ t('common.ui.filter') }}
        </button>
        <button 
          @click="toggleStatistics"
          class="btn btn-sm"
          :class="{ 'btn-primary': showStatisticsPanel, 'btn-secondary': !showStatisticsPanel }"
        >
          <i class="bx bx-bar-chart"></i>
          {{ t('vulnerability.statistics') }}
        </button>
      </div>
      
      <div class="header-actions">
        <button @click="refreshData" class="btn btn-sm btn-primary">
          <i class="bx bx-refresh"></i>
          {{ t('common.ui.refresh') }}
        </button>
        <button @click="exportData" class="btn btn-sm btn-success">
          <i class="bx bx-export"></i>
          {{ t('common.export') }}
        </button>
        <button @click="clearData" class="btn btn-sm btn-danger">
          <i class="bx bx-trash"></i>
          {{ t('common.actions.clear') }}
        </button>
      </div>
    </div>

    <!-- 主体内容 -->
    <div class="main-content">
      <!-- 侧边栏 -->
      <div 
        class="sidebar scrollbar-thin" 
        v-if="showStatisticsPanel || showFilterPanel"
        :class="{
          'single-panel': (showStatisticsPanel && !showFilterPanel) || (!showStatisticsPanel && showFilterPanel),
          'dual-panel': showStatisticsPanel && showFilterPanel
        }"
      >
        <!-- 统计面板 -->
        <VulnerabilityStatistics 
          v-if="showStatisticsPanel"
          :statistics="statistics"
          class="sidebar-panel statistics-panel"
          :key="`vuln-stats-${themeChangeKey}`"
        />
        
        <!-- 过滤器面板 -->
        <VulnerabilityFilter
          v-if="showFilterPanel"
          :filter="filter"
          :available-types="vulnerabilityStore.availableTypes"
          :available-plugins="vulnerabilityStore.availablePlugins"
          @filter-change="handleFilterChange"
          class="sidebar-panel filter-panel"
          :key="`vuln-filter-${themeChangeKey}`"
        />
      </div>

      <!-- 漏洞列表 -->
      <div class="vulnerability-content">
        <VulnerabilityPanel
          :vulnerabilities="filteredVulnerabilities"
          :selected-vulnerability="selectedVulnerability"
          @vulnerability-select="handleVulnerabilitySelect"
          :key="`vuln-panel-${themeChangeKey}`"
        />
      </div>
    </div>

    <!-- 清空确认对话框 -->
    <ConfirmDialog
      v-model="showClearConfirm"
      :title="t('vulnerability.clear_title', '清空漏洞数据')"
      :message="t('vulnerability.confirm_clear', '确认清空所有漏洞数据？此操作不可恢复。')"
      :confirm-text="t('common.actions.clear', '清空')"
      :cancel-text="t('common.actions.cancel', '取消')"
      type="danger"
      @confirm="handleConfirmClear"
    />
  </div>
</template>

<style scoped>
.vulnerability-view {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: var(--color-bg-primary);
  color: var(--color-text-primary);
}

.main-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.sidebar {
  width: 320px;
  background: var(--color-bg-secondary);
  border-right: 1px solid var(--color-border);
  overflow: hidden;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
}

.sidebar-panel {
  overflow-y: auto;
  border-bottom: 1px solid var(--color-border);
}

/* 单个面板时占满100%高度 */
.sidebar.single-panel .sidebar-panel {
  flex: 1;
  border-bottom: none;
}

/* 双面板时各占50%高度 */
.sidebar.dual-panel .statistics-panel {
  flex: 0 0 50%;
  max-height: 50%;
}

.sidebar.dual-panel .filter-panel {
  flex: 0 0 50%;
  max-height: 50%;
  border-bottom: none;
}

.vulnerability-content {
  flex: 1;
  overflow: hidden;
}
</style> 